---
title: "p8105_hw6_qz2527"
author: "kindle zhang"
date: "2023-11-29"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(modelr)

set.seed(1)
```

# Problem 1

```{r q1_data_cleaning}
homicide_df = 
  read_csv("./data_file/homicide-data.csv",
           na = c("", "NA", "Unknown")) |> 
  janitor::clean_names() |> 
  mutate(
    city_state = str_c(city , ", ", state),
    # or we can use
    # city_state = str_c(city ,state, sep = ", ")
    victim_age = as.numeric(victim_age),
    resolution = as.numeric(disposition == "Closed by arrest"),
    # or we can use
    #   resolution = case_when(
    #     disposition == "Closed without arrest" ~ 0,
    #     disposition == "Open/No arrest"        ~ 0,
    #     disposition == "Closed by arrest"      ~ 1)
    # ) 
  ) |> 
  filter(victim_race %in% c("White", "Black")) |> 
  filter(!(city_state %in% c("Dallas, TX", "Phoenix, AZ", "Kansas City, MO", "Tulsa, AL"))) |> 
  select(city_state, resolution, victim_age, victim_sex, victim_race)
```

```{r q1_glm_baltimore}
baltomore_glm = 
  homicide_df |> 
  filter(city_state == "Baltimore, MD") |>
  glm(resolution ~ victim_age + victim_sex + victim_race, family = binomial(), data = _)

baltomore_glm |> 
  broom::tidy() |> 
  mutate(
    OR = exp(estimate),
    OR_CI_upper = exp(estimate + 1.96 * std.error),
    OR_CI_lower = exp(estimate - 1.96 * std.error)
  ) |> 
  filter(term == "victim_sexMale") |> 
  select(OR, OR_CI_lower, OR_CI_upper) |>
  knitr::kable(digits = 3)
```

```{r q1_glm_all_cities}
model_results = 
  homicide_df |> 
  nest(data = -city_state) |> 
  mutate(
    models = map(data, \(df) glm(resolution ~ victim_age + victim_sex + victim_race, family = binomial(), data = df)),
    tidy_models = map(models, broom::tidy)
  ) |> 
  select(-data, -models) |> 
  unnest(cols = tidy_models) |> 
  mutate(
    OR = exp(estimate),
    OR_CI_upper = exp(estimate + 1.96 * std.error),
    OR_CI_lower = exp(estimate - 1.96 * std.error)
  ) |> 
  filter(term == "victim_sexMale") |> 
  select(city_state, OR, OR_CI_lower, OR_CI_upper)

model_results |>
  slice(1:5) |>
  knitr::kable(digits = 3)
```

```{r}
model_results |>
  mutate(city_state = fct_reorder(city_state, OR)) |>
  ## like reorder
  ggplot(aes(x = city_state, y = OR)) + geom_point() +
  geom_errorbar(aes(ymin = OR_CI_lower, ymax = OR_CI_upper)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

# Problem 2

first, I import the data and tidy it.

```{r import_the_data}
weather_df = 
  rnoaa::meteo_pull_monitors(
    c("USW00094728"),
    var = c("PRCP", "TMIN", "TMAX"), 
    date_min = "2022-01-01",
    date_max = "2022-12-31") |>
  mutate(
    name = recode(id, USW00094728 = "CentralPark_NY"),
    tmin = tmin / 10,
    tmax = tmax / 10) |>
  select(name, id, everything())
```

make a function to bootstrap first.

```{r}
boot_sample = function(df){
  sample_frac(df, replace  = TRUE)
} 
```

make a multiple linear regression

```{r}
weather_fit = 
  weather_df |> 
    lm(tmax ~ tmin + prcp, data = _) 

weather_fit |> 
    broom::tidy()
```

Get the residuals and plot it

```{r}
weather_df |>
  modelr::add_residuals(weather_fit) |>
  ggplot(aes(x = tmin, y = resid)) + 
  geom_point()

weather_df |>
  modelr::add_residuals(weather_fit) |>
  ggplot(aes(x = prcp, y = resid)) + 
  geom_point()
```

Then, I use the bootstrapping and find the $\hat{r}^2$ and $log(\hat{\beta}_1*\hat{\beta}_2)$

```{r}
boot_straps = 
  tibble(strap_number = 1:50) |> 
  mutate(
    strap_sample = map(strap_number, \(df) boot_sample(df = weather_df)),
    models = map(strap_sample,\(df) lm(tmax ~ tmin + prcp, data = df)),
    results_1 = map(models, broom::tidy),
    results_2 = map(models, broom::glance)) |> 
  select(strap_number, starts_with("results")) |> 
  unnest(results_1, results_2) |> 
  janitor::clean_names() |> 
  filter(term %in% c("tmin", "prcp")) |> 
  select(strap_number, term, estimate, adj_r_squared) |> 
  pivot_wider(
    names_from = term,
    values_from = estimate
  ) |> 
  rename(tmin_esti = tmin, prcp_esti = prcp) |> 
  mutate(ln_beta1_beta2 = log(tmin_esti * prcp_esti)) |> 
  select(strap_number, adj_r_squared, ln_beta1_beta2)
  
boot_straps
```

Then, identify the 2.5% and 97.5% quantiles to provide a 95% confidence interval for these two variable. 

```{r}
boot_straps |> 
  pivot_longer(
    adj_r_squared : ln_beta1_beta2,
    names_to = "term", 
    values_to = "estimate"
  ) |> 
  group_by(term) |> 
  summarise(
    ci_lower = quantile(estimate, 0.025, na.rm = TRUE),
    ci_higher = quantile(estimate, 0.975, na.rm = TRUE)
  ) |> 
  knitr::kable()
```
Then we can find the quantile of these two variables under a 95% confidence level interval

# Problem 3


